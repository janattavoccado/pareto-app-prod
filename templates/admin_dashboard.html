<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pareto Admin Dashboard</title>
    
    <!-- Material Design CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/materialize.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/admin_dashboard.css">
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-wrapper">
            <span class="brand-logo">
                <i class="material-icons" style="vertical-align: middle; margin-right: 8px;">dashboard</i>
                Pareto Admin
            </span>
            <div class="nav-right">
                <i class="material-icons theme-toggle" id="themeToggle" title="Toggle theme">brightness_4</i>
                <div class="user-info">
                    <span id="adminName">Admin</span>
                    <div class="user-avatar" id="userAvatar">A</div>
                </div>
                <button class="btn btn-secondary btn-small" id="logoutBtn">
                    <i class="material-icons" style="font-size: 18px;">logout</i>
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container-main" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-item active" data-page="dashboard">
                <i class="material-icons">dashboard</i>
                <span>Dashboard</span>
            </div>
            <div class="sidebar-item" data-page="users">
                <i class="material-icons">people</i>
                <span>Users</span>
            </div>
            <div class="sidebar-item" data-page="tenants">
                <i class="material-icons">business</i>
                <span>Tenants</span>
            </div>
            <div class="sidebar-item" data-page="crm">
                <i class="material-icons">contacts</i>
                <span>CRM Leads</span>
            </div>
            <div class="sidebar-item" data-page="audit-logs">
                <i class="material-icons">history</i>
                <span>Audit Logs</span>
            </div>
            <div class="sidebar-item" data-page="settings">
                <i class="material-icons">settings</i>
                <span>Settings</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page">
                <div class="page-header">
                    <h1>Dashboard</h1>
                </div>

                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalTenants">0</div>
                        <div class="stat-label">Total Tenants</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUsers">0</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalAdmins">0</div>
                        <div class="stat-label">Total Admins</div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">Recent Activity</h2>
                    <div id="recentActivityContainer">
                        <p style="text-align: center; color: #7f8c8d;">No recent activity</p>
                    </div>
                </div>
            </div>

            <!-- Users Page -->
            <div id="usersPage" class="page hidden">
                <div class="page-header">
                    <h1>Users Management</h1>
                    <button class="btn btn-primary" id="addUserBtn">
                        <i class="material-icons">add</i>
                        Add User
                    </button>
                </div>
                
                <div class="card">
                    <div class="filters">
                        <input type="text" id="userSearchInput" placeholder="Search users...">
                        <select id="userFilterEnabled">
                            <option value="">All Statuses</option>
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Calendar</th>
                                    <th>Status</th>
                                    <th>Token</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- User rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tenants Page -->
            <div id="tenantsPage" class="page hidden">
                <div class="page-header">
                    <h1>Tenants Management</h1>
                    <button class="btn btn-primary" id="addTenantBtn">
                        <i class="material-icons">add</i>
                        Add Tenant
                    </button>
                </div>
                <div class="card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Company</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Users</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tenantsTableBody">
                                <!-- Tenant rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Audit Logs Page -->
            <div id="auditLogsPage" class="page hidden">
                <div class="page-header">
                    <h1>Audit Logs</h1>
                </div>
                <div class="card">
                    <div class="filters">
                        <select id="auditFilterAction">
                            <option value="">All Actions</option>
                            <option value="CREATE">Create</option>
                            <option value="UPDATE">Update</option>
                            <option value="DELETE">Delete</option>
                            <option value="LOGIN">Login</option>
                            <option value="LOGOUT">Logout</option>
                        </select>
                        <select id="auditFilterEntity">
                            <option value="">All Entities</option>
                            <option value="USER">User</option>
                            <option value="TENANT">Tenant</option>
                            <option value="ADMIN">Admin</option>
                        </select>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Admin</th>
                                    <th>Action</th>
                                    <th>Entity</th>
                                    <th>Date/Time</th>
                                </tr>
                            </thead>
                            <tbody id="auditLogsTableBody">
                                <!-- Audit log rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- CRM Page -->
            <div id="crmPage" class="page hidden">
                <div class="page-header">
                    <h1>CRM Leads</h1>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="crmTenantFilter" class="form-control" style="width: 200px;">
                            <option value="">All Tenants</option>
                        </select>
                        <select id="crmStatusFilter" class="form-control" style="width: 150px;">
                            <option value="">All Statuses</option>
                            <option value="Open">Open</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Closed">Closed</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                        <select id="crmPriorityFilter" class="form-control" style="width: 150px;">
                            <option value="">All Priorities</option>
                            <option value="High">High</option>
                            <option value="Mid">Mid</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                </div>

                <!-- CRM Stats -->
                <div class="stats-grid" id="crmStatsGrid">
                    <div class="stat-card">
                        <div class="stat-value" id="crmTotalLeads">0</div>
                        <div class="stat-label">Total Leads</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="crmOpenLeads">0</div>
                        <div class="stat-label">Open</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="crmInProgressLeads">0</div>
                        <div class="stat-label">In Progress</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="crmHighPriorityLeads">0</div>
                        <div class="stat-label">High Priority</div>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Subject</th>
                                    <th>Tenant</th>
                                    <th>Created By</th>
                                    <th>Owner</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="crmLeadsTableBody">
                                <!-- CRM lead rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="settingsPage" class="page hidden">
                <div class="page-header">
                    <h1>Settings</h1>
                </div>
                <div class="card">
                    <h2 class="card-title">Change Password</h2>
                    <form id="changePasswordForm">
                        <div class="form-group">
                            <label for="currentPassword">Current Password</label>
                            <input type="password" id="currentPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <input type="password" id="newPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="confirmNewPassword">Confirm New Password</label>
                            <input type="password" id="confirmNewPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Change Password</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal-overlay active">
        <div class="modal">
            <div class="modal-header">
                <h2>Admin Login</h2>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" required>
                    </div>
                    <div id="loginError" class="alert alert-error hidden">
                        <i class="material-icons">error_outline</i>
                        <span id="loginErrorMsg"></span>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                </form>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="userModalTitle">Add User</h2>
                <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="form-group">
                        <label for="userTenant">Tenant</label>
                        <select id="userTenant" required></select>
                    </div>
                    <div class="form-group">
                        <label for="userFirstName">First Name</label>
                        <input type="text" id="userFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="userLastName">Last Name</label>
                        <input type="text" id="userLastName" required>
                    </div>
                    <div class="form-group">
                        <label for="userPhone">Phone Number</label>
                        <input type="tel" id="userPhone" required>
                    </div>
                    <div class="form-group">
                        <label for="userEmail">Email</label>
                        <input type="email" id="userEmail">
                    </div>
                    <div class="form-group">
                        <label for="userCalendarId">Google Calendar ID</label>
                        <input type="text" id="userCalendarId" placeholder="e.g., user_calendar_name or calendar@group.calendar.google.com">
                        <small style="color: #7f8c8d; display: block; margin-top: 4px;">The calendar ID within the shared Google account for this user's events.</small>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="userEnabled" checked />
                            <span>Enabled</span>
                        </label>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Token Modal -->
    <div id="tokenModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="tokenModalTitle">Manage Google Token</h2>
                <button class="modal-close" onclick="closeModal('tokenModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Manage Google credentials for <strong id="tokenUserName"></strong>.</p>
                
                <!-- Current Token Info (shown when token exists) -->
                <div id="currentTokenInfo" class="card" style="margin-bottom: 20px; display: none;">
                    <h3 style="font-size: 14px; margin-bottom: 10px;">Current Token</h3>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div>
                            <span style="color: #7f8c8d;">Status:</span>
                            <span class="badge badge-success" id="tokenStatus">Active</span>
                        </div>
                        <div>
                            <span style="color: #7f8c8d;">Last Updated:</span>
                            <span id="tokenLastUpdated">-</span>
                        </div>
                        <div style="margin-top: 10px;">
                            <button type="button" class="btn btn-small btn-info" onclick="downloadCurrentToken()">
                                <i class="material-icons" style="font-size: 16px;">download</i>
                                Download Token JSON
                            </button>
                            <button type="button" class="btn btn-small btn-danger" onclick="deleteCurrentToken()">
                                <i class="material-icons" style="font-size: 16px;">delete</i>
                                Delete Token
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- No Token Info (shown when no token exists) -->
                <div id="noTokenInfo" class="card" style="margin-bottom: 20px; display: none;">
                    <p style="color: #7f8c8d; text-align: center;">No token uploaded yet.</p>
                </div>
                
                <!-- Upload New Token -->
                <div class="form-group">
                    <label for="tokenFile">Upload New Credentials JSON File</label>
                    <input type="file" id="tokenFile" accept=".json">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('tokenModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="handleTokenUpload()">Upload</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>Confirm Deletion</h2>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('deleteConfirmModal')">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Tenant Modal -->
    <div id="tenantModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="tenantModalTitle">Edit Tenant</h2>
                <button class="modal-close" onclick="closeModal('tenantModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="tenantForm">
                    <input type="hidden" id="tenantId">
                    <div class="form-group">
                        <label for="companyName">Company Name</label>
                        <input type="text" id="companyName" required>
                    </div>
                    <div class="form-group">
                        <label for="companySlug">Company Slug</label>
                        <input type="text" id="companySlug" required>
                    </div>
                    <div class="form-group">
                        <label for="tenantEmail">Email</label>
                        <input type="email" id="tenantEmail">
                    </div>
                    <div class="form-group">
                        <label for="tenantPhone">Phone</label>
                        <input type="tel" id="tenantPhone">
                    </div>
                    <div class="form-group">
                        <label for="tenantActive">Status</label>
                        <select id="tenantActive">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('tenantModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- CRM Lead View Modal -->
    <div id="crmLeadModal" class="modal-overlay">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="crmLeadModalTitle">Lead Details</h2>
                <button class="modal-close" onclick="closeModal('crmLeadModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Subject</label>
                    <p id="crmLeadSubject" style="font-weight: bold; font-size: 16px;"></p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Tenant</label>
                        <p id="crmLeadTenant"></p>
                    </div>
                    <div class="form-group">
                        <label>Created By</label>
                        <p id="crmLeadCreatedBy"></p>
                    </div>
                    <div class="form-group">
                        <label>Owner</label>
                        <input type="text" id="crmLeadOwner" class="form-control" placeholder="Enter owner name">
                    </div>
                    <div class="form-group">
                        <label>Priority</label>
                        <select id="crmLeadPriority" class="form-control">
                            <option value="High">High</option>
                            <option value="Mid">Mid</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="crmLeadStatus" class="form-control">
                            <option value="Open">Open</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Closed">Closed</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Created</label>
                        <p id="crmLeadCreated"></p>
                    </div>
                </div>
                <div class="form-group">
                    <label>Content</label>
                    <div id="crmLeadContent" style="background: #f5f5f5; padding: 15px; border-radius: 8px; white-space: pre-wrap;"></div>
                </div>
                <div class="form-group" id="crmLeadActionsGroup">
                    <label>Actions</label>
                    <div id="crmLeadActions" style="background: #fff3cd; padding: 15px; border-radius: 8px;"></div>
                </div>
                <input type="hidden" id="crmLeadId">
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('crmLeadModal')">Close</button>
                    <button type="button" class="btn btn-primary" onclick="updateCrmLead()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom JavaScript -->
    <script src="/static/admin_dashboard.js"></script>
</body>
</html>
